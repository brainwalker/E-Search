<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>E-Search - Database Viewer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --bg-card: #1e1e35;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            --radius: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            border: 1px solid var(--border-color);
        }

        .header-title-link {
            text-decoration: none;
        }

        .header-title-link:hover h1 {
            opacity: 0.8;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex: 1;
            justify-content: flex-end;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .refresh-btn.refreshing {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .refresh-icon {
            display: inline-block;
            font-size: 16px;
            transition: transform 0.3s;
        }

        .refresh-btn.refreshing .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-row {
            height: 48px;
            margin-bottom: 2px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Performance optimizations */
        .table-btn, .stat-card, .source-card {
            will-change: transform, border-color;
        }

        .refresh-btn {
            will-change: transform, box-shadow;
        }

        /* Offline Banner */
        .offline-banner {
            display: none;
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius);
            padding: 12px 16px;
            margin-bottom: 16px;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        /* Scrape Status Banner */
        .scrape-status-banner {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scrape-status-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .scrape-status-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .scrape-status-icon {
            font-size: 1.2rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .scrape-status-title {
            font-weight: 600;
            font-size: 1rem;
            flex: 1;
        }

        .scrape-status-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .scrape-status-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .scrape-status-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .scrape-stat {
            display: flex;
            gap: 6px;
            align-items: center;
            color: white;
            font-size: 0.9rem;
        }

        .scrape-stat .stat-label {
            opacity: 0.9;
        }

        .scrape-stat .stat-new {
            color: #4ade80;
            font-weight: 600;
        }

        .scrape-stat .stat-updated {
            color: #60a5fa;
            font-weight: 600;
        }

        .scrape-stat .stat-errors {
            color: #fca5a5;
            font-weight: 600;
        }

        .offline-banner .retry-btn {
            padding: 8px 14px;
            border: none;
            background: var(--danger);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .offline-banner .retry-btn:hover {
            background: #dc2626;
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 4px;
        }

        /* Main Content Layout */
        .main-content {
            display: flex;
            gap: 20px;
            position: relative;
        }

        /* Smooth transitions for all expandable elements */
        .sidebar-wrapper,
        .main-content-wrapper,
        .sidebar-card,
        .sidebar-card-body,
        .logs-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Logs expanded state */
        body.logs-expanded .main-content-wrapper {
            opacity: 0;
            transform: translateX(50px);
            pointer-events: none;
            position: absolute;
            visibility: hidden;
        }

        body.logs-expanded .sidebar-wrapper {
            width: 100% !important;
            max-width: 100% !important;
        }

        body.logs-expanded .left-sidebar {
            max-height: none;
            overflow: visible;
            height: calc(100vh - 120px);
            gap: 0;
            padding: 0;
            margin: 0;
            top: 0;
        }

        body.logs-expanded #logsCard {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            margin: 0;
            border-radius: var(--radius-lg);
        }

        body.logs-expanded #logsCard .sidebar-card-header {
            display: none;
        }

        body.logs-expanded #logsCard .sidebar-card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        body.logs-expanded #logsCard .logs-container {
            flex: 1;
            max-height: none !important;
            min-height: 300px;
            height: 100% !important;
            overflow-y: scroll !important;
            overflow-x: hidden;
        }

        body.logs-expanded .sidebar-card:not(#logsCard) {
            display: none;
        }

        body.logs-expanded .sidebar-toggle {
            display: block;
        }

        body.logs-expanded .main-content {
            gap: 0;
        }

        /* Card collapse animation */
        .sidebar-card.collapsed .sidebar-card-body {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .sidebar-card:not(.collapsed) .sidebar-card-body {
            opacity: 1;
        }

        /* logsCard needs flex-based sizing, not max-height */
        #logsCard:not(.collapsed) .sidebar-card-body {
            max-height: none;
        }

        /* Sidebar Toggle */
        .sidebar-toggle {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1001;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            padding: 15px 8px;
            cursor: pointer;
            font-size: 1.1rem;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .sidebar-toggle:hover {
            transform: translateY(-50%) translateX(3px);
        }

        /* Sidebar */
        .sidebar-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 350px;
            min-width: 260px;
            max-width: 800px;
            max-height: calc(100vh - 200px);
            overflow: hidden;
            transition: width 0.3s ease;
            border: 2px solid yellow !important;
        }

        .sidebar-wrapper.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            max-width: 0 !important;
            overflow: hidden;
        }

        .left-sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            transition: opacity 0.3s ease;
        }

        .left-sidebar.collapsed {
            opacity: 0;
        }

        .sidebar-resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            right: -5px;
            width: 10px;
            cursor: col-resize;
            background: transparent;
            z-index: 1300;
        }

        .sidebar-resizer:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .main-content-wrapper {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            opacity: 1;
            transform: translateX(0);
            visibility: visible;
            position: relative;
            pointer-events: auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: var(--bg-secondary);
            padding: 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 16px 20px;
            transition: background 0.2s ease;
            flex-wrap: wrap;
            gap: 12px;
        }

        .collapsible-header:hover {
            background: var(--bg-tertiary);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .collapse-icon {
            font-size: 0.8rem;
            color: var(--accent-primary);
            transition: transform 0.3s ease;
        }

        .collapsible-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-section.collapsed .collapsible-content {
            max-height: 0;
        }

        .collapsible-content-inner {
            padding: 0 20px 20px;
        }

        /* Tables Section */
        .tables-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .table-btn {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .table-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .table-btn.active {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
        }

        /* Data Container */
        .data-container {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: auto;
            min-height: 400px;
        }

        .table-info {
            margin-bottom: 20px;
            padding: 12px 18px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
        }

        .table-info-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 0 0 auto;
        }

        .table-info-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .table-info strong {
            color: var(--accent-primary);
        }

        .table-info-right {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 0 0 auto;
        }

        .table-search {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-search input {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            width: 220px;
            transition: all 0.2s ease;
        }

        .table-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .table-search input::placeholder {
            color: var(--text-muted);
        }

        .table-info .pagination {
            margin-top: 0;
        }

        /* Data Table */
        .table-wrapper {
            max-height: calc(100vh - 320px);
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            background: var(--accent-gradient);
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

        tr:hover td {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
            justify-content: center;
        }

        .page-btn {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Schedules Section */
        .schedules-section {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease;
            width: 100%;
        }

        .schedules-section.hidden {
            display: none;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .schedules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .schedules-header h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .schedules-close {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .schedules-close:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .schedules-content {
            width: 100%;
        }

        .schedule-items-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            width: 100%;
        }

        .schedule-item-card {
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.2s ease;
        }

        .schedule-item-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .schedule-item-day {
            font-weight: 700;
            color: var(--accent-primary);
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .schedule-item-time {
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .schedule-item-town {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .schedule-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .no-schedule, .schedule-error {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            margin: 0;
        }

        .schedule-error {
            color: #f87171;
        }

        /* Clickable rows */
        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: rgba(99, 102, 241, 0.05) !important;
        }

        .clickable-row.schedule-selected {
            background: rgba(99, 102, 241, 0.1) !important;
            border-left: 3px solid var(--accent-primary);
        }

        /* Forms & Inputs */
        textarea {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
            resize: vertical;
            min-height: 100px;
            margin-bottom: 12px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-small {
            padding: 8px 14px;
            font-size: 0.85rem;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Logs Section */
        .logs-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
            justify-content: space-between;
        }

        .logs-controls-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .log-action-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .log-action-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .restart-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .restart-btn:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .logs-container {
            background: #0a0a10;
            color: #9ca3af;
            padding: 12px;
            border-radius: 8px;
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 0.72rem;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
            border: 1px solid var(--border-color);
        }

        .log-line {
            margin: 2px 0;
            padding: 2px 6px;
            border-radius: 3px;
            word-wrap: break-word;
            white-space: pre-wrap;
            transition: background 0.1s ease;
        }

        .log-line:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .log-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-right: 8px;
            opacity: 0.7;
        }

        .log-line.error {
            color: #f87171;
            background: rgba(248, 113, 113, 0.08);
            border-left: 2px solid #f87171;
        }
        .log-line.warning {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.08);
            border-left: 2px solid #fbbf24;
        }
        .log-line.info {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.05);
        }
        .log-line.debug {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.05);
        }
        .log-line.http-request {
            color: #a78bfa;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            font-size: 0.7rem;
            opacity: 0.85;
        }
        .log-line.http-request .http-method {
            color: #34d399;
            font-weight: 600;
        }
        .log-line.http-request .http-status-ok {
            color: #4ade80;
            font-weight: 600;
        }
        .log-line.http-request .http-status-error {
            color: #f87171;
            font-weight: 600;
        }

        /* Log filters */
        .logs-filters {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            align-items: center;
        }

        .log-filter-btn {
            padding: 3px 8px;
            font-size: 0.65rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
            opacity: 0.5;
        }

        .log-filter-btn:hover {
            opacity: 0.8;
        }

        .log-filter-btn.active {
            opacity: 1;
        }

        .log-filter-btn.active[data-filter="error"] {
            background: rgba(248, 113, 113, 0.2);
            border-color: #f87171;
            color: #f87171;
        }

        .log-filter-btn.active[data-filter="warning"] {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .log-filter-btn.active[data-filter="info"] {
            background: rgba(74, 222, 128, 0.2);
            border-color: #4ade80;
            color: #4ade80;
        }

        .log-filter-btn.active[data-filter="debug"] {
            background: rgba(96, 165, 250, 0.2);
            border-color: #60a5fa;
            color: #60a5fa;
        }

        .log-filter-btn.active[data-filter="http"] {
            background: rgba(167, 139, 250, 0.2);
            border-color: #a78bfa;
            color: #a78bfa;
        }

        /* Hidden log lines based on filter */
        .logs-container.hide-error .log-line.error,
        .logs-container.hide-warning .log-line.warning,
        .logs-container.hide-info .log-line.info,
        .logs-container.hide-debug .log-line.debug,
        .logs-container.hide-http .log-line.http-request {
            display: none;
        }

        .logs-status {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auto-scroll-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        .auto-scroll-indicator.paused {
            background: var(--danger);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Source Cards */
        .source-card {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .source-card:hover {
            border-color: var(--accent-primary);
        }

        .source-card h4 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .source-card p {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .source-card button {
            width: 100%;
        }

        /* JSON Cell */
        .json-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            color: var(--accent-primary);
        }

        .json-cell:hover {
            text-decoration: underline;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: var(--radius-lg);
            max-width: 800px;
            max-height: 80vh;
            overflow: auto;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        pre {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 10px;
            overflow: auto;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        /* Action buttons - icon only */
        .action-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.refresh { background: var(--success); color: white; }
        .action-btn.edit { background: var(--accent-primary); color: white; }
        .action-btn.delete { background: var(--danger); color: white; }

        .action-cell {
            display: flex;
            gap: 4px;
            align-items: center;
            height: 100%;
            padding: 8px 6px !important;
        }

        td.action-cell {
            vertical-align: middle;
        }

        /* Sortable columns */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: linear-gradient(135deg, #7b7ef7 0%, #9d8af8 100%);
        }

        th .sort-icon {
            margin-left: 4px;
            opacity: 0.5;
            font-size: 10px;
        }

        th.sorted-asc .sort-icon::after { content: '‚ñ≤'; opacity: 1; }
        th.sorted-desc .sort-icon::after { content: '‚ñº'; opacity: 1; }

        /* Multi-select */
        .select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .bulk-actions {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .bulk-actions.visible {
            display: flex;
        }

        .bulk-actions .count {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .table-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .table-tab {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transform: scale(1);
        }

        .table-tab:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
            transform: scale(1.02);
        }

        .table-tab:active {
            transform: scale(0.98);
        }

        .table-tab.active {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .table-tab .tab-name {
            font-size: 0.85rem;
            text-transform: capitalize;
        }

        .table-tab.active .tab-count {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .tab-count {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            background: var(--bg-secondary);
            border-radius: 10px;
            color: var(--accent-primary);
        }

        .db-size-indicator {
            padding: 10px 14px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .db-size-indicator::before {
            content: 'üíæ';
            font-size: 1rem;
        }

        /* Improved sidebar */
        .sidebar-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            flex-shrink: 0;
        }

        #logsCard {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: calc(100vh - 500px);
            min-height: 150px;
            border: 2px solid red !important;
        }

        #logsCard .sidebar-card-header {
            flex-shrink: 0;
        }

        #logsCard:not(.collapsed) .sidebar-card-body {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 2px solid green !important;
        }

        #logsCard:not(.collapsed) .logs-controls {
            flex-shrink: 0;
        }

        #logsCard:not(.collapsed) .logs-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto !important;
            border: 2px solid blue !important;
        }

        #logsCard:not(.collapsed) .logs-status {
            flex-shrink: 0;
        }

        .sidebar-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .sidebar-card-header:hover {
            background: var(--bg-card);
        }

        .sidebar-card-header .collapse-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .sidebar-card:not(.collapsed) .sidebar-card-header .collapse-icon {
            transform: rotate(0deg);
        }

        .sidebar-card.collapsed .sidebar-card-header .collapse-icon {
            transform: rotate(-90deg);
        }

        .sidebar-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-card-body {
            padding: 16px;
            overflow: hidden;
        }

        .scrape-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .scrape-btn {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scrape-btn:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .scrape-btn.scraping {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Sticky columns for listings table */
        .table-wrapper table th.sticky-col,
        .table-wrapper table td.sticky-col {
            position: sticky;
            background: var(--bg-secondary);
            z-index: 5;
        }

        .table-wrapper table th.sticky-col {
            background: var(--accent-gradient);
            z-index: 15;
        }

        .table-wrapper table th.sticky-checkbox,
        .table-wrapper table td.sticky-checkbox {
            left: 0;
            width: 40px;
        }

        .table-wrapper table th.sticky-actions,
        .table-wrapper table td.sticky-actions {
            left: 40px;
            width: 90px;
        }

        .table-wrapper table th.sticky-name,
        .table-wrapper table td.sticky-name {
            left: 130px;
            min-width: 150px;
        }

        .table-wrapper table tr:hover td.sticky-col {
            background: var(--bg-tertiary);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar-wrapper {
                width: 100% !important;
                max-width: 100% !important;
            }

            .left-sidebar {
                position: relative;
                max-height: none;
            }

            .sidebar-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="header-title-link">
                <h1>üìä Database Viewer</h1>
            </a>
            <div class="header-actions">
                <div class="table-tabs" id="tableList">
                    <div class="loading">Loading...</div>
                </div>
                <span class="db-size-indicator" id="dbSizeIndicator">...</span>
            </div>
        </header>

        <div class="offline-banner" id="offlineBanner">
            <span>‚ö†Ô∏è Backend is offline. Trying to reconnect...</span>
            <button class="retry-btn" onclick="manualRetry()">Retry now</button>
        </div>

        <!-- Scrape Status Banner -->
        <div id="scrapeStatusBanner" class="scrape-status-banner" style="display: none;">
            <div class="scrape-status-content">
                <div class="scrape-status-header">
                    <span class="scrape-status-icon">üîÑ</span>
                    <span class="scrape-status-title">Scraping in progress...</span>
                    <button class="scrape-status-close" onclick="closeScrapeStatus()">&times;</button>
                </div>
                <div class="scrape-status-details">
                    <div class="scrape-stat"><span class="stat-label">Source:</span> <span id="scrapingSource">-</span></div>
                    <div class="scrape-stat"><span class="stat-label">Progress:</span> <span id="scrapingProgress">0/0</span></div>
                    <div class="scrape-stat"><span class="stat-label">New:</span> <span id="scrapingNew" class="stat-new">0</span></div>
                    <div class="scrape-stat"><span class="stat-label">Updated:</span> <span id="scrapingUpdated" class="stat-updated">0</span></div>
                    <div class="scrape-stat"><span class="stat-label">Errors:</span> <span id="scrapingErrors" class="stat-errors">0</span></div>
                </div>
            </div>
        </div>

        <!-- Main Content Layout -->
        <div class="main-content">
            <!-- Sidebar Toggle Button -->
            <button class="sidebar-toggle collapsed" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle Tools Panel">
                <span id="sidebarToggleText">‚ñ∂ Tools</span>
            </button>

            <!-- Left Sidebar - Improved -->
            <div class="sidebar-wrapper collapsed" id="sidebarWrapper">
                <div class="left-sidebar collapsed" id="leftSidebar">
                    <!-- Scrape Sources -->
                    <div class="sidebar-card" id="scrapeCard">
                        <div class="sidebar-card-header" onclick="toggleCard('scrapeCard')">
                            <span class="sidebar-card-title">üîÑ Scrape Sources</span>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="sidebar-card-body">
                            <div class="scrape-grid" id="scrapeButtons">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Source Data Management -->
                    <div class="sidebar-card collapsed" id="sourceCard">
                        <div class="sidebar-card-header" onclick="toggleCard('sourceCard')">
                            <span class="sidebar-card-title">üóëÔ∏è Delete Data</span>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="sidebar-card-body">
                            <div id="sourcesList" style="display: flex; flex-direction: column; gap: 8px;">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- SQL Query -->
                    <div class="sidebar-card collapsed" id="queryCard">
                        <div class="sidebar-card-header" onclick="toggleCard('queryCard')">
                            <span class="sidebar-card-title">üîç SQL Query</span>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="sidebar-card-body">
                            <textarea id="sqlQuery" placeholder="SELECT * FROM listings LIMIT 10" style="min-height: 80px;">SELECT * FROM listings LIMIT 10</textarea>
                            <button class="btn-primary" onclick="executeQuery()" style="width: 100%; margin-top: 8px;">Run Query</button>
                        </div>
                    </div>

                    <!-- Backend Logs -->
                    <div class="sidebar-card collapsed" id="logsCard">
                        <div class="sidebar-card-header" onclick="toggleCard('logsCard')">
                            <span class="sidebar-card-title">üìã Logs</span>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="sidebar-card-body" style="padding: 12px;">
                            <div class="logs-controls" style="margin-bottom: 8px;">
                                <div class="logs-controls-left">
                                    <button class="log-action-btn" id="pauseLogsBtn" onclick="event.stopPropagation(); toggleLogsPause()" title="Pause/Resume">
                                        <span id="pauseIcon">‚è∏Ô∏è</span>
                                    </button>
                                    <div class="logs-filters" onclick="event.stopPropagation();">
                                        <button class="log-filter-btn active" data-filter="error" onclick="toggleLogFilter('error', this)" title="Errors">ERR</button>
                                        <button class="log-filter-btn active" data-filter="warning" onclick="toggleLogFilter('warning', this)" title="Warnings">WARN</button>
                                        <button class="log-filter-btn active" data-filter="info" onclick="toggleLogFilter('info', this)" title="Info">INFO</button>
                                        <button class="log-filter-btn active" data-filter="debug" onclick="toggleLogFilter('debug', this)" title="Debug">DBG</button>
                                        <button class="log-filter-btn" data-filter="http" onclick="toggleLogFilter('http', this)" title="HTTP requests (hidden by default)">HTTP</button>
                                    </div>
                                </div>
                                <button class="restart-btn" onclick="event.stopPropagation(); restartBackend()" title="Restart backend">üîÑ Restart</button>
                            </div>
                            <div class="logs-container" id="logsContainer">
                                <div class="loading"><p>Loading...</p></div>
                            </div>
                            <div class="logs-status" style="font-size: 0.75rem;">
                                <span id="autoScrollIndicator" class="auto-scroll-indicator"></span>
                                <span id="logsStatusText">Auto</span>
                                <span id="logsCount" style="margin-left: auto;">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-resizer" id="sidebarResizer"></div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content-wrapper">
                <!-- Bulk Actions Bar -->
                <div class="bulk-actions" id="bulkActions">
                    <span><span class="count" id="selectedCount">0</span> selected</span>
                    <button class="btn-danger btn-small" onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
                    <button class="btn-small" onclick="clearSelection()">Clear</button>
                </div>

                <!-- Data View Section -->
                <div class="data-container" id="dataContainer">
                    <div class="loading">
                        <p>Select a table or execute a query to view data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Modal -->
    <div class="modal" id="jsonModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3 style="margin-bottom: 16px; color: var(--text-primary);">JSON Data</h3>
            <pre id="jsonContent"></pre>
        </div>
    </div>

    <!-- Edit Listing Modal -->
    <div class="modal" id="editModal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
            <h3 style="margin-bottom: 16px; color: var(--text-primary);">Edit Listing</h3>
            <div id="editModalContent"></div>
        </div>
    </div>

    <!-- Extraction Debug Modal -->
    <div class="modal" id="extractionModal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow: auto;">
            <span class="modal-close" onclick="closeExtractionModal()">&times;</span>
            <div id="extractionContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000'
            : `${window.location.protocol}//${window.location.hostname}:8000`;
        let currentTable = null;
        let currentPage = 1;
        let isRefreshing = false;
        let backendOnline = true;
        let retryTimer = null;
        const SIDEBAR_MIN = 260;
        const SIDEBAR_MAX = 800;
        const SIDEBAR_DEFAULT = 350;
        const SIDEBAR_LOGS_WIDTH = 700;

        // Logs management
        let logsAutoUpdate = true;
        let logsPaused = false;
        let logsUpdateInterval = null;
        let lastLogTimestamp = null;
        let logsAbortController = null;
        let logsCleared = false;

        // Browser-compatible timeout signal (AbortSignal.timeout not supported in all browsers)
        function createTimeoutSignal(ms) {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), ms);
            return controller.signal;
        }

        // Sorting state
        let sortColumn = null;
        let sortDirection = 'asc';

        // Search state
        let nameSearchQuery = '';
        let searchDebounceTimer = null;

        // Selection state
        let selectedRows = new Set();

        // Sources for scraping
        let allSources = [];

        // Utility function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        async function init() {
            console.log('üîÑ Initializing database viewer...');
            initLogFilters();
            await refreshDatabase();
            // Note: refreshDatabase() already calls loadLogs() and startLogsAutoUpdate()
            initSidebarResizer();
        }

        // Backend connectivity
        function setBackendStatus(isUp) {
            backendOnline = isUp;
            const banner = document.getElementById('offlineBanner');
            if (banner) {
                banner.style.display = isUp ? 'none' : 'flex';
            }
            if (isUp) {
                // Backend is up - clear retry timer and resume auto-updates
                if (retryTimer) {
                    clearTimeout(retryTimer);
                    retryTimer = null;
                }
                // Resume logs auto-update if it was enabled
                if (logsAutoUpdate && !logsUpdateInterval) {
                    startLogsAutoUpdate();
                }
            } else {
                // Backend is down - stop all auto-updates and set retry timer
                stopLogsAutoUpdate();
                if (retryTimer) {
                    clearTimeout(retryTimer);
                }
                retryTimer = setTimeout(() => refreshDatabase(true), 5000);
            }
        }

        function manualRetry() {
            if (retryTimer) {
                clearTimeout(retryTimer);
                retryTimer = null;
            }
            refreshDatabase(true);
        }

        // Refresh all database data
        async function refreshDatabase(force = false) {
            if (isRefreshing && !force) return;

            isRefreshing = true;
            const refreshBtn = document.getElementById('refreshBtn');
            
            if (refreshBtn) {
                refreshBtn.classList.add('refreshing');
                refreshBtn.disabled = true;
            }

            try {
                // Check backend status first
                if (!await checkBackendConnection()) {
                    setBackendStatus(false);
                    throw new Error('Backend is not responding');
                }

                document.getElementById('tableList').innerHTML = '<div class="loading">Loading...</div>';
                document.getElementById('sourcesList').innerHTML = '<div class="loading">Loading...</div>';
                document.getElementById('scrapeButtons').innerHTML = '<div class="loading">Loading...</div>';

                // Use Promise.allSettled to handle partial failures gracefully
                const results = await Promise.allSettled([
                    loadStats().catch(e => { setBackendStatus(false); throw e; }),
                    loadTables().catch(e => { setBackendStatus(false); throw e; }),
                    loadSources().catch(e => { setBackendStatus(false); throw e; })
                ]);

                // Check if any requests failed
                const failures = results.filter(r => r.status === 'rejected');
                if (failures.length > 0) {
                    const errorMessages = failures.map(r => r.reason?.message || 'Unknown error').join(', ');
                    throw new Error(`Some requests failed: ${errorMessages}`);
                }

                if (currentTable && backendOnline) {
                    await loadTable(currentTable, currentPage).catch(e => {
                        if (e.message.includes('Failed to fetch') || e.message.includes('ERR_CONNECTION_REFUSED')) {
                            setBackendStatus(false);
                        }
                    });
                } else if (!currentTable) {
                    document.getElementById('dataContainer').innerHTML = '<div class="loading"><p>Select a table or execute a query to view data</p></div>';
                }

                if (backendOnline) {
                    stopLogsAutoUpdate();
                    await loadLogs().catch(() => {}); // Silently fail logs
                    startLogsAutoUpdate();
                }

                setBackendStatus(true);
            } catch (error) {
                // Only log non-connection errors
                if (!error.message.includes('Failed to fetch') && !error.message.includes('ERR_CONNECTION_REFUSED') && !error.message.includes('not responding')) {
                    console.error('Error refreshing:', error);
                }
                setBackendStatus(false);
                document.getElementById('tableList').innerHTML = `<div style="background: rgba(239, 68, 68, 0.1); padding: 12px 16px; border-radius: 8px; color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); font-size: 0.85rem;"><strong>Connection Error:</strong> Backend is not responding.</div>`;
            } finally {
                isRefreshing = false;
                if (refreshBtn) {
                    refreshBtn.classList.remove('refreshing');
                    refreshBtn.disabled = false;
                }
            }
        }

        // Quick backend connection check
        async function checkBackendConnection() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const response = await fetch(`${API_BASE}/`, {
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Load sources - populates both scrape buttons and delete list
        async function loadSources() {
            if (!backendOnline) return;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${API_BASE}/api/sources`, {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                allSources = await response.json();

                // Populate scrape buttons
                const scrapeContainer = document.getElementById('scrapeButtons');
                scrapeContainer.innerHTML = '';
                allSources.forEach(source => {
                    const apiName = getSourceApiName(source.name);
                    const btn = document.createElement('button');
                    btn.className = 'scrape-btn';
                    btn.id = `scrape-${apiName}`;
                    btn.innerHTML = `üîÑ ${source.name}`;
                    btn.onclick = () => scrapeSource(apiName, btn);
                    scrapeContainer.appendChild(btn);
                });

                // Populate delete list
                const deleteContainer = document.getElementById('sourcesList');
                deleteContainer.innerHTML = '';
                allSources.forEach(source => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;';
                    row.innerHTML = `
                        <span style="font-size: 0.85rem;">${source.name}</span>
                        <button class="btn-danger btn-small" onclick="deleteSourceData(${source.id}, '${source.name}')" style="padding: 4px 8px;">üóëÔ∏è</button>
                    `;
                    deleteContainer.appendChild(row);
                });
            } catch (error) {
                if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED')) {
                    setBackendStatus(false);
                }
                document.getElementById('scrapeButtons').innerHTML = `<span style="color: #fca5a5;">Error</span>`;
                document.getElementById('sourcesList').innerHTML = `<span style="color: #fca5a5;">Error</span>`;
                throw error;
            }
        }

        // Get API name for source
        function getSourceApiName(sourceName) {
            if (!sourceName || typeof sourceName !== 'string') return 'unknown';
            const nameLower = sourceName.toLowerCase();
            if (nameLower.includes('sexyfriendstoronto') || nameLower.includes('sft')) return 'sft';
            if (nameLower.includes('discreet') || nameLower.includes('dd')) return 'dd';
            return nameLower.replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
        }

        // Parse progress from log lines during scraping
        function parseProgressFromLogs(logs, sourceKey) {
            const stats = { current: 0, total: 0, new: 0, updated: 0, errors: 0 };
            const sourceUpper = sourceKey.toUpperCase();

            // Process logs in reverse to get latest state first
            for (let i = logs.length - 1; i >= 0; i--) {
                const line = logs[i];

                // Only process lines for this source
                if (!line.includes(`scraper.${sourceUpper}`) && !line.includes(`scraper.${sourceKey}`)) continue;

                // Match progress pattern: [53/53] Processing
                const progressMatch = line.match(/\[(\d+)\/(\d+)\]\s*Processing/);
                if (progressMatch && stats.total === 0) {
                    stats.current = parseInt(progressMatch[1]);
                    stats.total = parseInt(progressMatch[2]);
                }

                // Count new/updated from individual entries
                if (line.includes('[NEW]')) stats.new++;
                if (line.includes('[UPD]')) stats.updated++;
                if (line.includes('[ERR]') || line.includes('ERROR')) stats.errors++;
            }

            return stats;
        }

        // Scrape a single source
        async function scrapeSource(apiName, btn) {
            if (btn.classList.contains('scraping')) return;

            btn.classList.add('scraping');
            const originalText = btn.innerHTML;
            btn.innerHTML = `‚è≥ Scraping...`;

            showScrapeStatus(apiName.toUpperCase());

            // Auto-expand log view
            expandLogsView();

            // Start polling logs for progress updates
            let progressPollInterval = null;
            const pollProgress = async () => {
                try {
                    const logsResponse = await fetch(`${API_BASE}/db/logs?lines=100`, {
                        cache: 'no-cache',
                        headers: { 'Cache-Control': 'no-cache' }
                    });
                    if (logsResponse.ok) {
                        const logsData = await logsResponse.json();
                        if (logsData.logs && logsData.logs.length > 0) {
                            const stats = parseProgressFromLogs(logsData.logs, apiName);
                            if (stats.total > 0) {
                                document.getElementById('scrapingProgress').textContent = `${stats.current}/${stats.total}`;
                                document.getElementById('scrapingNew').textContent = stats.new;
                                document.getElementById('scrapingUpdated').textContent = stats.updated;
                                document.getElementById('scrapingErrors').textContent = stats.errors;
                            }
                        }
                    }
                } catch (e) {
                    // Silently ignore polling errors
                }
            };

            // Poll every 2 seconds during scraping
            progressPollInterval = setInterval(pollProgress, 2000);
            // Also poll immediately
            pollProgress();

            try {
                const response = await fetch(`${API_BASE}/api/scrape/${apiName}`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();

                // Stop polling once complete
                if (progressPollInterval) clearInterval(progressPollInterval);

                updateScrapeStatus(result);
                completeScrapeStatus(result);

                btn.innerHTML = `‚úì Done!`;
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
                await loadStats();
                if (currentTable === 'listings') await loadTable(currentTable, currentPage);
            } catch (error) {
                // Stop polling on error
                if (progressPollInterval) clearInterval(progressPollInterval);

                const errorResult = { errors: 1, new: 0, updated: 0, total: 0 };
                updateScrapeStatus(errorResult);
                completeScrapeStatus(errorResult);

                btn.innerHTML = `‚úó Error`;
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            } finally {
                btn.classList.remove('scraping');
            }
        }

        // Scrape Status Banner Functions
        function showScrapeStatus(source) {
            const banner = document.getElementById('scrapeStatusBanner');
            document.getElementById('scrapingSource').textContent = source;
            document.getElementById('scrapingProgress').textContent = '0/0';
            document.getElementById('scrapingNew').textContent = '0';
            document.getElementById('scrapingUpdated').textContent = '0';
            document.getElementById('scrapingErrors').textContent = '0';
            banner.style.display = 'block';
        }

        function updateScrapeStatus(data) {
            if (data.source) document.getElementById('scrapingSource').textContent = data.source;
            if (data.total !== undefined) {
                const processed = (data.new || 0) + (data.updated || 0) + (data.errors || 0);
                document.getElementById('scrapingProgress').textContent = `${processed}/${data.total}`;
            }
            if (data.new !== undefined) document.getElementById('scrapingNew').textContent = data.new;
            if (data.updated !== undefined) document.getElementById('scrapingUpdated').textContent = data.updated;
            if (data.errors !== undefined) document.getElementById('scrapingErrors').textContent = data.errors;
        }

        function closeScrapeStatus() {
            document.getElementById('scrapeStatusBanner').style.display = 'none';
        }

        function completeScrapeStatus(data) {
            const banner = document.getElementById('scrapeStatusBanner');
            const icon = banner.querySelector('.scrape-status-icon');
            const title = banner.querySelector('.scrape-status-title');

            if (data.errors > 0) {
                icon.textContent = '‚ö†Ô∏è';
                title.textContent = 'Scraping completed with errors';
            } else {
                icon.textContent = '‚úÖ';
                title.textContent = 'Scraping completed successfully!';
            }

            setTimeout(() => {
                closeScrapeStatus();
            }, 5000);
        }

        // Delete source data
        async function deleteSourceData(sourceId, sourceName) {
            if (!confirm(`Delete ALL listings from "${sourceName}"?`)) return;

            try {
                const response = await fetch(`${API_BASE}/api/sources/${sourceId}/data`, { method: 'DELETE' });
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await loadStats();
                if (currentTable === 'listings' || currentTable === 'schedules') {
                    await loadTable(currentTable, currentPage);
                }
            } catch (error) {
                alert('‚ùå Error deleting data');
            }
        }

        // Cached stats for table counts
        let tableStats = {};

        // Load stats (called to refresh counts)
        async function loadStats() {
            if (!backendOnline) return;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${API_BASE}/db/stats`, {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const stats = await response.json();
                tableStats = { ...stats };

                // Update tab counts if tabs exist
                updateTabCounts();
            } catch (error) {
                if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED')) {
                    setBackendStatus(false);
                }
                throw error;
            }
        }

        // Update tab button counts
        function updateTabCounts() {
            const tableIcons = {
                listings: 'üìã',
                schedules: 'üìÖ',
                sources: 'üåê',
                tiers: '‚≠ê',
                locations: 'üìç',
                rates: 'üí∞'
            };

            document.querySelectorAll('.table-tab').forEach(btn => {
                const tableName = btn.dataset.tableName;
                if (tableName && tableStats[tableName] !== undefined) {
                    const icon = tableIcons[tableName] || 'üìÑ';
                    btn.innerHTML = `<span class="tab-name">${icon} ${tableName}</span><span class="tab-count">${tableStats[tableName]}</span>`;
                }
            });

            // Update DB size indicator if exists
            const dbSizeEl = document.getElementById('dbSizeIndicator');
            if (dbSizeEl && tableStats._database_size_mb) {
                dbSizeEl.textContent = `${tableStats._database_size_mb} MB`;
            }
        }

        // Load tables - tab format with counts
        async function loadTables() {
            if (!backendOnline) return;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${API_BASE}/db/tables`, {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const container = document.getElementById('tableList');
                container.innerHTML = '';

                // Table icon mapping
                const tableIcons = {
                    listings: 'üìã',
                    schedules: 'üìÖ',
                    sources: 'üåê',
                    tiers: '‚≠ê',
                    locations: 'üìç',
                    rates: 'üí∞'
                };

                data.tables.forEach(table => {
                    const btn = document.createElement('button');
                    btn.className = 'table-tab';
                    btn.dataset.tableName = table.name;
                    const count = tableStats[table.name] !== undefined ? tableStats[table.name] : '...';
                    const icon = tableIcons[table.name] || 'üìÑ';
                    btn.innerHTML = `<span class="tab-name">${icon} ${table.name}</span><span class="tab-count">${count}</span>`;
                    btn.onclick = () => {
                        clearSelection();
                        sortColumn = null;
                        sortDirection = 'asc';
                        // Exit logs expanded mode if active
                        if (document.body.classList.contains('logs-expanded')) {
                            document.body.classList.remove('logs-expanded');
                            const logsCard = document.getElementById('logsCard');
                            if (logsCard) {
                                logsCard.classList.add('collapsed');
                            }
                        }
                        loadTable(table.name);
                        // Collapse sidebar when table is clicked
                        collapseSidebar();
                    };
                    container.appendChild(btn);
                });
            } catch (error) {
                if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED')) {
                    setBackendStatus(false);
                }
                document.getElementById('tableList').innerHTML = `<span style="color: #fca5a5;">Error</span>`;
                throw error;
            }
        }

        // Handle name search input
        function handleNameSearch(event) {
            const query = event.target.value;
            nameSearchQuery = query;

            // Debounce the search
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                loadTable(currentTable, 1); // Reset to page 1 on new search
            }, 300);
        }

        // Load table data
        async function loadTable(tableName, page = 1) {
            // Reset search when switching tables
            if (currentTable !== tableName) {
                nameSearchQuery = '';
            }

            currentTable = tableName;
            currentPage = page;

            // Highlight the selected table tab
            document.querySelectorAll('.table-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tableName === tableName);
            });

            const container = document.getElementById('dataContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading data...</p></div>';

            try {
                let url = `${API_BASE}/db/table/${tableName}?page=${page}`;

                // Add search parameter for listings table
                if (tableName === 'listings' && nameSearchQuery) {
                    url += `&search=${encodeURIComponent(nameSearchQuery)}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<p style="color: #fca5a5;">${data.error}</p>`;
                    return;
                }

                displayTableData(data);
            } catch (error) {
                container.innerHTML = '<p style="color: #fca5a5;">Error loading table data</p>';
            }
        }

        // Store current table data for schedule display
        let currentTableData = null;
        let selectedListingId = null;

        // Display table data with sortable columns, icon buttons, multi-select
        function displayTableData(data) {
            const container = document.getElementById('dataContainer');
            const hasActions = ['listings', 'locations', 'tiers'].includes(data.table);
            const hasSchedules = data.schedules && Object.keys(data.schedules).length > 0;

            // Store data for schedule section
            currentTableData = data;

            // Reorder columns for listings table
            if (data.table === 'listings') {
                const desiredOrder = [
                    'source_id', 'name', 'tier', 'age', 'measurements', 'bust', 'bust_type',
                    'service_type', 'height', 'weight', 'hair_color', 'eye_color',
                    'nationality', 'ethnicity'
                ];

                // Reorder columns: prioritize desired order, then append any remaining columns
                const reorderedColumns = [];
                desiredOrder.forEach(col => {
                    if (data.columns.includes(col)) {
                        reorderedColumns.push(col);
                    }
                });

                // Add any remaining columns not in the desired order
                data.columns.forEach(col => {
                    if (!desiredOrder.includes(col) && !reorderedColumns.includes(col)) {
                        reorderedColumns.push(col);
                    }
                });

                data.columns = reorderedColumns;
            }

            // Sort data if sort column is set
            let sortedData = [...data.data];
            if (sortColumn && data.columns.includes(sortColumn)) {
                sortedData.sort((a, b) => {
                    const aVal = a[sortColumn];
                    const bVal = b[sortColumn];
                    if (aVal === null) return 1;
                    if (bVal === null) return -1;
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    const comparison = String(aVal).localeCompare(String(bVal));
                    return sortDirection === 'asc' ? comparison : -comparison;
                });
            }

            // Build search HTML for listings table
            const searchHtml = data.table === 'listings' ? `
                <div class="table-search">
                    <input type="text" id="nameSearchInput" placeholder="Search by name..." value="${nameSearchQuery}" onkeyup="handleNameSearch(event)">
                </div>
            ` : '';

            // Build pagination HTML
            const paginationHtml = data.total_pages > 1 ? `
                <div class="pagination">
                    <button class="page-btn" onclick="loadTable('${data.table}', ${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}>‚Üê</button>
                    <span style="color: var(--text-secondary);">${data.page}/${data.total_pages}</span>
                    <button class="page-btn" onclick="loadTable('${data.table}', ${data.page + 1})" ${data.page === data.total_pages ? 'disabled' : ''}>‚Üí</button>
                </div>
            ` : '';

            let html = `
                <div class="table-info">
                    <div class="table-info-left">
                        <div><strong>${data.table}</strong> - ${data.total_count} rows</div>
                    </div>
                    <div class="table-info-center">
                        ${searchHtml}
                    </div>
                    <div class="table-info-right">
                        ${paginationHtml}
                    </div>
                </div>
            `;

            if (sortedData.length === 0) {
                html += '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No data</p>';
            } else {
                html += '<div class="table-wrapper"><table><thead><tr>';

                // Checkbox column for multi-select (only for listings)
                if (data.table === 'listings') {
                    html += `<th class="sticky-col sticky-checkbox"><input type="checkbox" class="select-checkbox" onchange="toggleSelectAll(this)"></th>`;
                }

                // Actions column
                if (hasActions) {
                    html += `<th class="sticky-col sticky-actions">Actions</th>`;
                }

                // Sortable column headers
                data.columns.forEach(col => {
                    const isSorted = sortColumn === col;
                    const sortClass = isSorted ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                    const stickyClass = (data.table === 'listings' && col === 'name') ? 'sticky-col sticky-name' : '';
                    html += `<th class="sortable ${sortClass} ${stickyClass}" onclick="sortTable('${col}')">${col}<span class="sort-icon"></span></th>`;
                });
                html += '</tr></thead><tbody>';

                sortedData.forEach(row => {
                    const rowId = row['id'];
                    const isSelected = selectedRows.has(rowId);
                    const rowName = row['name'] || '';
                    const clickHandler = (data.table === 'listings') ? `onclick="showScheduleForRow(${rowId}, '${escapeHtml(rowName).replace(/'/g, "\\'")}', event)"` : '';
                    const clickableClass = (data.table === 'listings') ? 'clickable-row' : '';
                    html += `<tr data-row-id="${rowId}" class="${isSelected ? 'selected' : ''} ${clickableClass}" ${clickHandler}>`;

                    // Checkbox
                    if (data.table === 'listings') {
                        html += `<td class="sticky-col sticky-checkbox"><input type="checkbox" class="select-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRowSelect(${rowId}, this)"></td>`;
                    }

                    // Action buttons - icon only
                    if (data.table === 'listings') {
                        html += `<td class="action-cell sticky-col sticky-actions">
                            <button class="action-btn refresh" onclick="refreshSingleListing(${rowId})" title="Refresh">üîÑ</button>
                            <button class="action-btn edit" onclick="editSingleRow('listings', ${rowId})" title="Edit">‚úèÔ∏è</button>
                        </td>`;
                    } else if (data.table === 'locations') {
                        html += `<td class="action-cell sticky-col sticky-actions">
                            <button class="action-btn edit" onclick="editSingleRow('locations', ${rowId})" title="Edit">‚úèÔ∏è</button>
                        </td>`;
                    } else if (data.table === 'tiers') {
                        html += `<td class="action-cell sticky-col sticky-actions">
                            <button class="action-btn edit" onclick="editSingleRow('tiers', ${rowId})" title="Edit">‚úèÔ∏è</button>
                        </td>`;
                    }

                    // Data columns
                    data.columns.forEach(col => {
                        const value = row[col];
                        let displayValue = value;

                        if (typeof value === 'string' && (value.startsWith('[') || value.startsWith('{'))) {
                            try {
                                JSON.parse(value);
                                displayValue = `<span class="json-cell" onclick='showJson(${JSON.stringify(value).replace(/'/g, "&#39;")})'>[JSON]</span>`;
                            } catch (e) {
                                displayValue = escapeHtml(value);
                            }
                        } else if (value === null) {
                            displayValue = '<em style="color: var(--text-muted);">-</em>';
                        } else if (typeof value === 'boolean') {
                            displayValue = value ? '‚úì' : '‚úó';
                        } else {
                            displayValue = escapeHtml(String(value));
                        }

                        // Add sticky class for name column in listings table, and add profile link
                        const stickyClass = (data.table === 'listings' && col === 'name') ? 'sticky-col sticky-name' : '';

                        // Add hyperlink to profile for name column (do this AFTER escaping HTML)
                        if (data.table === 'listings' && col === 'name' && row['profile_url'] && value !== null) {
                            // Look up source from source_id
                            const sourceId = row['source_id'];
                            const sourceObj = allSources.find(s => s.id === sourceId);

                            if (sourceObj && sourceObj.base_url) {
                                // Use the base_url from the sources table
                                const fullUrl = sourceObj.base_url + row['profile_url'];
                                // displayValue is already escaped, so wrap it in link
                                displayValue = `<a href="${escapeHtml(fullUrl)}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-primary); text-decoration: none; font-weight: 600;">${displayValue}</a>`;
                            }
                        }

                        html += `<td class="${stickyClass}">${displayValue}</td>`;
                    });

                    html += '</tr>';
                });

                html += '</tbody></table></div>';

                // Add schedules section placeholder for listings table (hidden by default)
                if (data.table === 'listings') {
                    html += `<div class="schedules-section hidden" id="schedulesSection">
                        <div class="schedules-header">
                            <h3>üìÖ Schedule</h3>
                            <button class="schedules-close" onclick="hideScheduleSection()">‚úï</button>
                        </div>
                        <div class="schedules-content" id="schedulesContent">
                        </div>
                    </div>`;
                }
            }

            container.innerHTML = html;
            updateBulkActionsBar();
        }

        // Show schedule for a specific row when clicked
        async function showScheduleForRow(rowId, rowName, event) {
            // Don't trigger if clicking on buttons, checkboxes, or links
            if (event && (event.target.closest('button') || event.target.closest('input') || event.target.closest('a'))) {
                return;
            }

            const section = document.getElementById('schedulesSection');
            const content = document.getElementById('schedulesContent');

            if (!section || !content) return;

            // Highlight selected row
            document.querySelectorAll('tr.clickable-row').forEach(tr => {
                tr.classList.remove('schedule-selected');
            });
            document.querySelector(`tr[data-row-id="${rowId}"]`)?.classList.add('schedule-selected');

            // Update header with name
            section.querySelector('h3').innerHTML = `üìÖ Schedule for <span style="color: var(--accent-primary)">${escapeHtml(rowName)}</span>`;

            // Show loading state
            content.innerHTML = '<div class="schedule-loading">Loading schedule...</div>';
            section.classList.remove('hidden');

            try {
                // Fetch schedule from API
                const response = await fetch(`${API_BASE}/db/listing/${rowId}/schedules`);
                const data = await response.json();

                if (data.schedules && data.schedules.length > 0) {
                    content.innerHTML = `<div class="schedule-items-row">
                        ${data.schedules.map(s => `
                            <div class="schedule-item-card">
                                <div class="schedule-item-day">${s.day}</div>
                                <div class="schedule-item-time">${s.start || '?'} - ${s.end || '?'}</div>
                                ${s.town ? `<div class="schedule-item-town">üìç ${s.town}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>`;
                } else {
                    content.innerHTML = '<p class="no-schedule">No schedule available for this listing</p>';
                }
            } catch (error) {
                content.innerHTML = '<p class="schedule-error">Failed to load schedule</p>';
            }

            // Scroll to schedules section
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Hide schedule section
        function hideScheduleSection() {
            const section = document.getElementById('schedulesSection');
            if (section) {
                section.classList.add('hidden');
            }
            // Remove row highlight
            document.querySelectorAll('tr.clickable-row').forEach(tr => {
                tr.classList.remove('schedule-selected');
            });
        }

        // Sorting
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            loadTable(currentTable, currentPage);
        }

        // Multi-select functions
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('tbody .select-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const rowId = parseInt(cb.closest('tr').dataset.rowId);
                if (checkbox.checked) {
                    selectedRows.add(rowId);
                } else {
                    selectedRows.delete(rowId);
                }
            });
            updateBulkActionsBar();
        }

        function toggleRowSelect(rowId, checkbox) {
            if (checkbox.checked) {
                selectedRows.add(rowId);
            } else {
                selectedRows.delete(rowId);
            }
            updateBulkActionsBar();
        }

        function clearSelection() {
            selectedRows.clear();
            document.querySelectorAll('.select-checkbox').forEach(cb => cb.checked = false);
            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActions');
            const count = document.getElementById('selectedCount');
            if (selectedRows.size > 0) {
                bar.classList.add('visible');
                count.textContent = selectedRows.size;
            } else {
                bar.classList.remove('visible');
            }
        }

        async function deleteSelected() {
            if (selectedRows.size === 0) return;
            if (!confirm(`Delete ${selectedRows.size} selected listing(s)?`)) return;

            const ids = Array.from(selectedRows);
            let deleted = 0;
            for (const id of ids) {
                try {
                    const res = await fetch(`${API_BASE}/api/listings/${id}`, { method: 'DELETE' });
                    if (res.ok) deleted++;
                } catch (e) {}
            }
            alert(`Deleted ${deleted} of ${ids.length} listings`);
            clearSelection();
            await loadStats();
            await loadTable(currentTable, currentPage);
        }

        // Execute query
        async function executeQuery() {
            const sql = document.getElementById('sqlQuery').value.trim();
            if (!sql) {
                alert('Please enter a SQL query');
                return;
            }

            const container = document.getElementById('dataContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Executing query...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/db/query?sql=${encodeURIComponent(sql)}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<p style="color: #fca5a5;">Error: ${data.error}</p>`;
                    return;
                }

                let html = `<div class="table-info"><div><strong>Query Results</strong> - ${data.count} rows</div></div>`;

                if (data.data.length === 0) {
                    html += '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Query returned no results</p>';
                } else {
                    html += '<div style="overflow-x: auto;"><table><thead><tr>';
                    data.columns.forEach(col => {
                        html += `<th>${col}</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    data.data.forEach(row => {
                        html += '<tr>';
                        data.columns.forEach(col => {
                            const value = row[col];
                            let displayValue = value;

                            if (typeof value === 'string' && (value.startsWith('[') || value.startsWith('{'))) {
                                try {
                                    JSON.parse(value);
                                    displayValue = `<span class="json-cell" onclick='showJson(${JSON.stringify(value).replace(/'/g, "&#39;")})'>[JSON]</span>`;
                                } catch (e) {
                                    displayValue = value;
                                }
                            } else if (value === null) {
                                displayValue = '<em style="color: var(--text-muted);">null</em>';
                            }

                            html += `<td>${displayValue}</td>`;
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p style="color: #fca5a5;">Error executing query</p>';
            }
        }

        // JSON Modal
        function showJson(jsonString) {
            const modal = document.getElementById('jsonModal');
            const content = document.getElementById('jsonContent');
            try {
                content.textContent = JSON.stringify(JSON.parse(jsonString), null, 2);
            } catch (e) {
                content.textContent = jsonString;
            }
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('jsonModal').classList.remove('show');
        }

        document.getElementById('jsonModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Edit Modal click-outside-to-close
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });

        document.getElementById('extractionModal').addEventListener('click', function(e) {
            if (e.target === this) closeExtractionModal();
        });

        // Logs
        async function loadLogs() {
            // Don't try to load logs if backend is known to be offline
            if (!backendOnline) {
                return;
            }

            // Cancel any in-flight request
            if (logsAbortController) {
                logsAbortController.abort();
            }

            try {
                const url = lastLogTimestamp
                    ? `${API_BASE}/db/logs?lines=200&since=${encodeURIComponent(lastLogTimestamp)}`
                    : `${API_BASE}/db/logs?lines=200`;

                logsAbortController = new AbortController();
                const timeoutId = setTimeout(() => logsAbortController.abort(), 5000); // 5 second timeout

                const response = await fetch(url, {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' },
                    signal: logsAbortController.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    if (response.status === 404) {
                        document.getElementById('logsContainer').innerHTML = `<div style="color: #fbbf24; text-align: center; padding: 20px;">
                            <p><strong>‚ö†Ô∏è Logs endpoint not available</strong></p>
                            <p>Please restart the backend server.</p>
                        </div>`;
                        stopLogsAutoUpdate();
                        setBackendStatus(false);
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const container = document.getElementById('logsContainer');
                const countEl = document.getElementById('logsCount');

                if (!data.file_exists) {
                    container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 20px;">${data.message || 'No logs yet.'}</div>`;
                    countEl.textContent = '0 lines';
                    return;
                }

                countEl.textContent = `${data.total_lines} lines`;

                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    // If logs were cleared, only show new logs (don't refetch all 500 lines)
                    if (!logsPaused && !logsCleared) {
                        const allLogsResponse = await fetch(`${API_BASE}/db/logs?lines=500`, {
                            cache: 'no-cache',
                            headers: { 'Cache-Control': 'no-cache' }
                        });
                        const allLogsData = await allLogsResponse.json();
                        if (allLogsData.logs) {
                            allLogsData.logs.forEach(line => {
                                html += formatLogLine(line);
                            });
                        }
                    } else {
                        // If logs cleared or paused, only append new logs incrementally
                        html = container.innerHTML;
                        data.logs.forEach(line => {
                            html += formatLogLine(line);
                        });
                        // Once we have new logs, unset the cleared flag
                        if (logsCleared && data.logs.length > 0) {
                            logsCleared = false;
                        }
                    }

                    container.innerHTML = html;

                    if (!logsPaused) {
                        container.scrollTop = container.scrollHeight;
                    }

                    if (data.last_updated) {
                        lastLogTimestamp = data.last_updated;
                    }
                }
            } catch (error) {
                // Ignore abort errors (from timeout or cancelled requests)
                if (error.name === 'AbortError') {
                    return;
                }
                // Only log error if it's not a connection refused (backend is down)
                if (!error.message.includes('Failed to fetch') && !error.message.includes('ERR_CONNECTION_REFUSED')) {
                    console.error('Error loading logs:', error);
                }
                // Mark backend as offline and stop auto-updates
                setBackendStatus(false);
            }
        }

        function formatTimestamp(dateStr, timeStr) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const [year, month, day] = dateStr.split('-');
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'pm' : 'am';
            const hour12 = hour % 12 || 12;
            return `${months[parseInt(month) - 1]} ${parseInt(day)}, ${hour12}:${minutes}${ampm}`;
        }

        function formatLogLine(line) {
            let className = '';
            let formattedLine = line;
            let timePrefix = '';
            let logLevel = '';

            // Convert timestamp pattern like "2025-12-12 01:49:46,422 - scraper.DD - INFO - " to readable format
            const timestampPattern = /^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}):\d{2},\d{3}\s+-\s+[\w.]+\s+-\s+(INFO|DEBUG|WARNING|ERROR|CRITICAL)\s+-\s*/;
            const tsMatch = line.match(timestampPattern);
            if (tsMatch) {
                const readableTime = formatTimestamp(tsMatch[1], tsMatch[2]);
                logLevel = tsMatch[3];
                timePrefix = `<span class="log-time">${readableTime}</span> `;
                formattedLine = line.replace(timestampPattern, '');
            }

            // Check for HTTP request pattern (e.g., "INFO:     127.0.0.1:49966 - "GET /db/table/listings HTTP/1.1" 200 OK")
            const httpPattern = /^INFO:\s+[\d.:]+\s+-\s+"(GET|POST|PUT|DELETE|PATCH)\s+([^"]+)\s+HTTP\/[\d.]+"\s+(\d+)\s+(\w+)$/;
            const httpMatch = formattedLine.match(httpPattern);

            if (httpMatch) {
                const method = httpMatch[1];
                const path = httpMatch[2];
                const statusCode = parseInt(httpMatch[3]);
                const statusText = httpMatch[4];

                className = 'http-request';
                const statusClass = statusCode >= 400 ? 'http-status-error' : 'http-status-ok';
                formattedLine = `<span class="http-method">${method}</span> ${escapeHtml(path)} <span class="${statusClass}">${statusCode} ${statusText}</span>`;
                return `<div class="log-line ${className}">${timePrefix}${formattedLine}</div>`;
            }

            // Classify based on extracted log level or content
            if (logLevel === 'ERROR' || logLevel === 'CRITICAL' || line.includes('errors)')) className = 'error';
            else if (logLevel === 'WARNING' || line.includes('WARN')) className = 'warning';
            else if (logLevel === 'INFO') className = 'info';
            else if (logLevel === 'DEBUG') className = 'debug';
            else if (line.includes('Progress:') || line.includes('‚ùØ‚ùØ‚ùØ') || line.includes('‚úÖ')) className = 'info';

            const div = document.createElement('div');
            div.textContent = formattedLine;
            return `<div class="log-line ${className}">${timePrefix}${div.innerHTML}</div>`;
        }

        function clearLogs() {
            const container = document.getElementById('logsContainer');
            container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Logs cleared</div>';
            document.getElementById('logsCount').textContent = '0 lines';
            // Set the timestamp to current time to only show NEW logs from this point forward
            lastLogTimestamp = new Date().toISOString();
            logsCleared = true;
        }

        // Log filter state - HTTP hidden by default
        const logFilters = {
            error: true,
            warning: true,
            info: true,
            debug: true,
            http: false
        };

        function toggleLogFilter(filterType, btn) {
            logFilters[filterType] = !logFilters[filterType];
            btn.classList.toggle('active', logFilters[filterType]);

            const container = document.getElementById('logsContainer');
            container.classList.toggle(`hide-${filterType}`, !logFilters[filterType]);
        }

        function initLogFilters() {
            const container = document.getElementById('logsContainer');
            // Apply initial filter states
            Object.entries(logFilters).forEach(([filter, enabled]) => {
                if (!enabled) {
                    container.classList.add(`hide-${filter}`);
                }
            });
        }

        function toggleLogsPause() {
            logsPaused = !logsPaused;
            const pauseIcon = document.getElementById('pauseIcon');
            const indicator = document.getElementById('autoScrollIndicator');
            const statusText = document.getElementById('logsStatusText');

            if (logsPaused) {
                pauseIcon.textContent = '‚ñ∂Ô∏è';
                indicator.classList.add('paused');
                statusText.textContent = 'Paused';
            } else {
                pauseIcon.textContent = '‚è∏Ô∏è';
                indicator.classList.remove('paused');
                statusText.textContent = 'Auto-updating...';
                document.getElementById('logsContainer').scrollTop = document.getElementById('logsContainer').scrollHeight;
            }
        }

        async function refreshLogs() {
            lastLogTimestamp = null;
            logsCleared = false;
            await loadLogs();
        }

        function startLogsAutoUpdate() {
            if (logsUpdateInterval) clearInterval(logsUpdateInterval);
            // Only start auto-update if backend is online
            if (!backendOnline) {
                return;
            }
            logsUpdateInterval = setInterval(() => {
                if (logsAutoUpdate && !logsPaused && backendOnline) {
                    loadLogs();
                }
            }, 2000);
        }

        function stopLogsAutoUpdate() {
            if (logsUpdateInterval) {
                clearInterval(logsUpdateInterval);
                logsUpdateInterval = null;
            }
        }

        async function restartBackend() {
            if (!confirm('Restart the backend server?')) return;

            try {
                const response = await fetch(`${API_BASE}/db/restart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (response.ok) {
                    // Backend will restart, show reconnecting state
                    setBackendStatus(false);
                    document.getElementById('logsContainer').innerHTML =
                        '<div style="color: var(--accent-primary); text-align: center; padding: 20px;">üîÑ Backend restarting...</div>';

                    // Wait and then try to reconnect
                    setTimeout(async () => {
                        lastLogTimestamp = null;
                        logsCleared = false;
                        await refreshDatabase();
                    }, 2000);
                } else {
                    alert(`‚ùå ${data.detail || 'Failed to restart'}`);
                }
            } catch (error) {
                // Connection lost is expected during restart
                if (error.message.includes('Failed to fetch')) {
                    setBackendStatus(false);
                    document.getElementById('logsContainer').innerHTML =
                        '<div style="color: var(--accent-primary); text-align: center; padding: 20px;">üîÑ Backend restarting...</div>';

                    setTimeout(async () => {
                        lastLogTimestamp = null;
                        logsCleared = false;
                        await refreshDatabase();
                    }, 2000);
                } else {
                    alert(`‚ùå Error: ${error.message}`);
                }
            }
        }

        // Expand logs view to full screen
        function expandLogsView() {
            const logsCard = document.getElementById('logsCard');
            const wrapper = document.getElementById('sidebarWrapper');

            if (!logsCard || logsCard.classList.contains('collapsed') === false && document.body.classList.contains('logs-expanded')) {
                return; // Already expanded
            }

            // Expand the logs card if collapsed
            if (logsCard.classList.contains('collapsed')) {
                logsCard.classList.remove('collapsed');
            }

            // Collapse other cards
            document.querySelectorAll('.sidebar-card').forEach(card => {
                if (card.id !== 'logsCard' && !card.classList.contains('collapsed')) {
                    card.classList.add('collapsed');
                }
            });

            // Expand to full width
            document.body.classList.add('logs-expanded');
            if (wrapper) {
                wrapper.classList.remove('collapsed');
                wrapper.style.width = '100%';
            }
        }

        // Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const wrapper = document.getElementById('sidebarWrapper');
            const toggle = document.getElementById('sidebarToggle');
            const toggleText = document.getElementById('sidebarToggleText');

            if (!sidebar || !toggle || !wrapper) return;

            const isCollapsed = sidebar.classList.contains('collapsed');
            sidebar.classList.toggle('collapsed');
            wrapper.classList.toggle('collapsed');

            if (isCollapsed) {
                toggle.classList.add('expanded');
                toggle.classList.remove('collapsed');
                toggleText.textContent = '‚óÄ Tools';
                wrapper.style.width = `${SIDEBAR_DEFAULT}px`;
            } else {
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
                toggleText.textContent = '‚ñ∂ Tools';
                wrapper.style.width = '0px';
            }
        }

        function collapseSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const wrapper = document.getElementById('sidebarWrapper');
            const toggle = document.getElementById('sidebarToggle');
            const toggleText = document.getElementById('sidebarToggleText');

            if (!sidebar || !wrapper) return;
            if (sidebar.classList.contains('collapsed')) return; // Already collapsed

            sidebar.classList.add('collapsed');
            wrapper.classList.add('collapsed');
            wrapper.style.width = '0px';

            if (toggle) {
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            }
            if (toggleText) {
                toggleText.textContent = '‚ñ∂ Tools';
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const icon = section.querySelector('.collapse-icon');
            section.classList.toggle('collapsed');

            if (icon) {
                icon.textContent = section.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
            }
        }

        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const wasCollapsed = card.classList.contains('collapsed');
            const wrapper = document.getElementById('sidebarWrapper');

            // Auto-collapse other cards when expanding this one
            if (wasCollapsed) {
                const allCards = document.querySelectorAll('.sidebar-card');
                allCards.forEach(otherCard => {
                    if (otherCard.id !== cardId && !otherCard.classList.contains('collapsed')) {
                        otherCard.classList.add('collapsed');
                    }
                });
            }

            card.classList.toggle('collapsed');

            // Special handling for logs card - expand to full width
            if (cardId === 'logsCard') {
                if (!card.classList.contains('collapsed')) {
                    // Expand logs to full width, hide table view
                    document.body.classList.add('logs-expanded');
                    wrapper.classList.remove('collapsed');
                    wrapper.style.width = '100%';
                    // Ensure logs are loaded when expanding
                    loadLogs();
                } else {
                    // Collapse logs, restore normal view
                    document.body.classList.remove('logs-expanded');
                    wrapper.style.width = `${SIDEBAR_DEFAULT}px`;
                }
            }
        }

        function initSidebarResizer() {
            const resizer = document.getElementById('sidebarResizer');
            const wrapper = document.getElementById('sidebarWrapper');
            if (!resizer || !wrapper) return;

            let isDragging = false;

            resizer.addEventListener('mousedown', (e) => {
                if (wrapper.classList.contains('collapsed')) return;
                isDragging = true;
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = wrapper.getBoundingClientRect();
                const newWidth = Math.min(Math.max(e.clientX - rect.left, SIDEBAR_MIN), SIDEBAR_MAX);
                wrapper.style.width = `${newWidth}px`;
            });

            window.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }
            });
        }

        // Listing actions
        async function refreshSingleListing(listingId) {
            try {
                // Show loading in modal
                showExtractionModal('Loading extraction details...', true);
                
                // Fetch debug extraction info
                const res = await fetch(`${API_BASE}/api/listings/${listingId}/debug-extraction`);
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to fetch extraction data');
                }
                
                const debugData = await res.json();
                showExtractionDetails(debugData);
                
            } catch (e) {
                showExtractionModal(`<div style="color: #f87171;">Error: ${e.message}</div>`, false);
            }
        }

        function showExtractionModal(content, isLoading = false, listingId = null) {
            const modal = document.getElementById('extractionModal');
            const modalContent = document.getElementById('extractionContent');
            
            if (isLoading) {
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 16px; color: var(--text-secondary);">${content}</p>
                    </div>
                `;
            } else {
                // Add Apply Changes button at the bottom if we have a listingId
                let finalContent = content;
                if (listingId) {
                    finalContent += `
                        <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
                            <button onclick="applyExtractionChanges(${listingId})" 
                                    style="padding: 12px 24px; background: var(--accent-gradient); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                                ‚ú® Apply Changes to Database
                            </button>
                            <p style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                                This will update the listing with the newly scraped values shown above.
                            </p>
                        </div>
                    `;
                }
                modalContent.innerHTML = finalContent;
            }
            
            modal.classList.add('show');
        }

        function showExtractionDetails(debugData) {
            const { profile_url, profile_data, extractions, text_snippets, current_db_values } = debugData;
            
            let html = `
                <h3 style="color: var(--accent-primary); margin-bottom: 16px;">üîç Extraction Debug Info</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">
                    Profile URL: <a href="${profile_url}" target="_blank" style="color: var(--accent-primary);">${profile_url}</a>
                </p>
                
                <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="background: var(--bg-tertiary);">
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Field</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Matched</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Raw Text Found</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">Extracted Value</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color);">DB Value</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const fields = ['tier', 'age', 'nationality', 'ethnicity', 'height', 'weight', 'measurements', 'bust', 'eye_color', 'hair_color', 'service_type'];
            
            for (const field of fields) {
                const ext = extractions[field] || {};
                const dbVal = current_db_values[field];
                const matched = ext.matched;
                const matchIcon = matched ? '‚úÖ' : '‚ùå';
                const matchColor = matched ? '#34d399' : '#f87171';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 10px; font-weight: 600; color: var(--text-primary);">${field}</td>
                        <td style="padding: 10px; color: ${matchColor};">${matchIcon}</td>
                        <td style="padding: 10px; color: var(--text-secondary); font-family: monospace; font-size: 0.8rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                            ${ext.raw_text ? escapeHtml(ext.raw_text) : '<em>-</em>'}
                        </td>
                        <td style="padding: 10px; color: ${matched ? '#34d399' : 'var(--text-muted)'};">
                            ${ext.final_value !== undefined ? ext.final_value : '<em>null</em>'}
                            ${ext.note ? `<br><small style="color: var(--text-muted);">${ext.note}</small>` : ''}
                            ${ext.source ? `<br><small style="color: var(--accent-primary);">via ${ext.source}</small>` : ''}
                        </td>
                        <td style="padding: 10px; color: var(--text-secondary);">
                            ${dbVal !== null && dbVal !== undefined ? dbVal : '<em>null</em>'}
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
                </div>
            `;
            
            // Text snippets section
            if (text_snippets && Object.keys(text_snippets).length > 0) {
                html += `
                    <h4 style="color: var(--accent-primary); margin: 24px 0 12px;">üìù Text Snippets Found</h4>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; font-family: monospace; font-size: 0.8rem;">
                `;
                for (const [field, snippet] of Object.entries(text_snippets)) {
                    html += `<div style="margin-bottom: 8px;"><strong style="color: var(--accent-primary);">${field}:</strong> <span style="color: var(--text-secondary);">${escapeHtml(snippet)}</span></div>`;
                }
                html += `</div>`;
            }
            
            // Images section
            if (extractions.images) {
                html += `
                    <h4 style="color: var(--accent-primary); margin: 24px 0 12px;">üñºÔ∏è Images Found: ${extractions.images.count}</h4>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">
                        ${extractions.images.final_value.length > 0 ? extractions.images.final_value.join(', ') : 'No images found'}
                    </div>
                `;
            }
            
            // Tags section
            if (extractions.tags) {
                html += `
                    <h4 style="color: var(--accent-primary); margin: 24px 0 12px;">üè∑Ô∏è Tags Found</h4>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">
                        ${extractions.tags.final_value.length > 0 ? extractions.tags.final_value.join(', ') : 'No tags matched'}
                    </div>
                `;
            }

            // Schedules section
            if (extractions.schedules) {
                const schedules = extractions.schedules.final_value || [];
                html += `
                    <h4 style="color: var(--accent-primary); margin: 24px 0 12px;">üìÖ Schedules Found: ${schedules.length}</h4>
                `;
                if (schedules.length > 0) {
                    html += `<div style="display: grid; gap: 8px;">`;
                    for (const sched of schedules) {
                        const location = typeof sched.location === 'object'
                            ? `${sched.location.town || ''}, ${sched.location.location || ''}`.replace(', ,', ',').replace(/^, |, $/g, '')
                            : (sched.location || '');
                        html += `
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; border-left: 3px solid var(--warning);">
                                <div style="font-weight: 600; color: var(--warning);">${sched.day_of_week || 'Unknown Day'}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                                    ${sched.start_time || ''} ${sched.end_time ? '- ' + sched.end_time : ''}
                                    ${location ? ' @ ' + location : ''}
                                </div>
                            </div>
                        `;
                    }
                    html += `</div>`;
                } else {
                    html += `<div style="color: var(--text-muted); font-size: 0.85rem;">No schedules found in profile</div>`;
                }
            }

            // Tier rates section
            if (debugData.tier_rates) {
                const rates = debugData.tier_rates;
                html += `
                    <h4 style="color: var(--accent-primary); margin: 24px 0 12px;">üí∞ Tier Rates (from tiers table)</h4>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; font-size: 0.85rem;">
                        <div style="margin-bottom: 8px;"><strong>Tier:</strong> ${rates.tier} (‚≠ê${rates.star})</div>
                        <div style="margin-bottom: 8px;"><strong>30min:</strong> ${rates.incall_30min || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>45min:</strong> ${rates.incall_45min || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>1hr:</strong> ${rates.incall_1hr || 'N/A'}</div>
                        <div><strong>Outcall/hr:</strong> ${rates.outcall_per_hr || 'N/A'}</div>
                    </div>
                `;
            } else {
                html += `
                    <h4 style="color: var(--accent-primary); margin: 24px 0 12px;">üí∞ Tier Rates</h4>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">No tier rates found (tier not matched in tiers table)</div>
                `;
            }
            
            showExtractionModal(html, false, debugData.current_db_values?.id);
        }

        function closeExtractionModal() {
            document.getElementById('extractionModal').classList.remove('show');
        }

        async function applyExtractionChanges(listingId) {
            if (!listingId) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Applying...';
            
            try {
                const res = await fetch(`${API_BASE}/api/listings/${listingId}/refresh`, { method: 'POST' });
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to apply changes');
                }
                
                const updated = await res.json();
                
                // Show success and close modal
                btn.textContent = '‚úÖ Applied!';
                btn.style.background = '#22c55e';
                
                // Refresh the table after a short delay
                setTimeout(() => {
                    closeExtractionModal();
                    if (currentTable === 'listings') {
                        loadTable('listings', currentPage);
                    }
                }, 1000);
                
            } catch (e) {
                btn.textContent = '‚ùå Failed';
                btn.style.background = '#ef4444';
                alert('Error: ' + e.message);
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = '‚ú® Apply Changes to Database';
                    btn.style.background = '';
                }, 2000);
            }
        }

        async function editSingleRow(tableName, rowId) {
            try {
                // Fetch the row data
                const res = await fetch(`${API_BASE}/db/table/${tableName}/row/${rowId}`);
                if (!res.ok) throw new Error('Failed to load row');
                const row = await res.json();
                
                // Define fields based on table type
                let fields = [];
                let title = '';
                
                if (tableName === 'listings') {
                    title = 'Edit Listing';
                    fields = [
                        { key: 'name', label: 'Name', type: 'text' },
                        { key: 'tier', label: 'Tier', type: 'text' },
                        { key: 'age', label: 'Age', type: 'number' },
                        { key: 'nationality', label: 'Nationality', type: 'text' },
                        { key: 'ethnicity', label: 'Ethnicity', type: 'text' },
                        { key: 'height', label: 'Height', type: 'text' },
                        { key: 'weight', label: 'Weight', type: 'text' },
                        { key: 'measurements', label: 'Measurements', type: 'text' },
                        { key: 'bust', label: 'Bust', type: 'text' },
                        { key: 'bust_type', label: 'Bust Type', type: 'text' },
                        { key: 'eye_color', label: 'Eye Color', type: 'text' },
                        { key: 'hair_color', label: 'Hair Color', type: 'text' },
                        { key: 'service_type', label: 'Service Type', type: 'text' },
                        { key: 'profile_url', label: 'Profile URL', type: 'text' },
                        { key: 'images', label: 'Images (JSON array)', type: 'textarea' },
                        { key: 'is_active', label: 'Is Active', type: 'checkbox' },
                        { key: 'is_expired', label: 'Is Expired', type: 'checkbox' },
                        { key: 'source_id', label: 'Source ID', type: 'number' },
                    ];
                } else if (tableName === 'locations') {
                    title = 'Edit Location';
                    fields = [
                        { key: 'town', label: 'Town', type: 'text' },
                        { key: 'location', label: 'Location', type: 'text' },
                        { key: 'address', label: 'Address', type: 'text' },
                        { key: 'notes', label: 'Notes', type: 'textarea' },
                        { key: 'source_id', label: 'Source ID', type: 'number' },
                        { key: 'is_default', label: 'Is Default', type: 'checkbox' },
                    ];
                } else if (tableName === 'tiers') {
                    title = 'Edit Tier';
                    fields = [
                        { key: 'tier', label: 'Tier', type: 'text' },
                        { key: 'star', label: 'Star', type: 'number' },
                        { key: 'source_id', label: 'Source ID', type: 'number' },
                        { key: 'incall_30min', label: 'Incall 30min', type: 'text' },
                        { key: 'incall_45min', label: 'Incall 45min', type: 'text' },
                        { key: 'incall_1hr', label: 'Incall 1hr', type: 'text' },
                        { key: 'outcall_per_hr', label: 'Outcall per hr', type: 'text' },
                    ];
                } else {
                    throw new Error(`Unknown table: ${tableName}`);
                }
                
                let html = `<form id="editRowForm" onsubmit="saveRowEdit(event, '${tableName}', ${rowId})">`;
                html += `<h3 style="margin-bottom: 16px; color: var(--text-primary);">${title}</h3>`;
                html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">';
                
                fields.forEach(field => {
                    const value = row[field.key] || '';
                    html += `<div style="display: flex; flex-direction: column;">`;
                    html += `<label style="margin-bottom: 4px; font-weight: 500; color: var(--text-secondary);">${field.label}</label>`;
                    
                    if (field.type === 'textarea') {
                        html += `<textarea name="${field.key}" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-family: monospace; min-height: 80px;">${typeof value === 'string' ? value : JSON.stringify(value)}</textarea>`;
                    } else if (field.type === 'checkbox') {
                        html += `<input type="checkbox" name="${field.key}" ${value ? 'checked' : ''} style="width: 20px; height: 20px;">`;
                    } else {
                        html += `<input type="${field.type}" name="${field.key}" value="${value}" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">`;
                    }
                    html += `</div>`;
                });
                
                html += '</div>';
                html += '<div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">';
                html += '<button type="button" onclick="closeEditModal()" style="padding: 10px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>';
                html += '<button type="submit" style="padding: 10px 20px; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Save Changes</button>';
                html += '</div>';
                html += '</form>';
                
                document.getElementById('editModalContent').innerHTML = html;
                document.getElementById('editModal').classList.add('show');
            } catch (e) {
                alert(`Error loading row: ${e.message}`);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function saveRowEdit(event, tableName, rowId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const updates = {};
            
            // Collect form data based on table type
            for (const [key, value] of formData.entries()) {
                if (tableName === 'listings') {
                    if (key === 'images') {
                        try {
                            updates[key] = JSON.parse(value);
                        } catch {
                            updates[key] = value || null;
                        }
                    } else if (key === 'is_active' || key === 'is_expired') {
                        updates[key] = formData.has(key);
                    } else if (key === 'age' || key === 'source_id') {
                        updates[key] = value ? parseInt(value) : null;
                    } else {
                        updates[key] = value || null;
                    }
                } else if (tableName === 'locations') {
                    if (key === 'is_default') {
                        updates[key] = formData.has(key);
                    } else if (key === 'source_id') {
                        updates[key] = value ? parseInt(value) : null;
                    } else {
                        updates[key] = value || null;
                    }
                } else if (tableName === 'tiers') {
                    if (key === 'source_id' || key === 'star') {
                        updates[key] = value ? parseInt(value) : null;
                    } else {
                        updates[key] = value || null;
                    }
                }
            }
            
            // Handle checkboxes that weren't checked
            if (tableName === 'listings') {
                if (!formData.has('is_active')) updates['is_active'] = false;
                if (!formData.has('is_expired')) updates['is_expired'] = false;
            } else if (tableName === 'locations') {
                if (!formData.has('is_default')) updates['is_default'] = false;
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                const res = await fetch(`${API_BASE}/db/table/${tableName}/row/${rowId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to save changes');
                }
                
                const result = await res.json();
                
                submitBtn.textContent = '‚úÖ Saved!';
                submitBtn.style.background = '#22c55e';
                
                // Refresh the table after a short delay
                setTimeout(() => {
                    closeEditModal();
                    if (currentTable === tableName) {
                        loadTable(tableName, currentPage);
                    }
                }, 1000);
                
            } catch (e) {
                submitBtn.textContent = '‚ùå Failed';
                submitBtn.style.background = '#ef4444';
                alert('Error: ' + e.message);
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    submitBtn.style.background = '';
                }, 2000);
            }
        }

        // Keep editSingleListing for backward compatibility
        async function editSingleListing(listingId) {
            await editSingleRow('listings', listingId);
        }

        async function deleteSingleListing(listingId) {
            if (!confirm('Delete this listing?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/listings/${listingId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed');
                if (currentTable === 'listings') await loadTable('listings', currentPage);
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (document.getElementById('extractionModal').classList.contains('show')) {
                    closeExtractionModal();
                } else if (document.getElementById('editModal').classList.contains('show')) {
                    closeEditModal();
                } else if (document.getElementById('jsonModal').classList.contains('show')) {
                    closeModal();
                }
            }
        });

        // Initialize
        window.addEventListener('load', init);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && !isRefreshing) {
                refreshDatabase();
                if (!logsPaused) loadLogs();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopLogsAutoUpdate();
            if (statsAutoRefreshInterval) clearInterval(statsAutoRefreshInterval);
            if (logsAbortController) logsAbortController.abort();
            if (retryTimer) clearTimeout(retryTimer);
        });

        // Auto-refresh stats every 15 seconds to show new listings
        let statsAutoRefreshInterval = null;
        let lastStatsSnapshot = null;

        function startStatsAutoRefresh() {
            if (statsAutoRefreshInterval) clearInterval(statsAutoRefreshInterval);
            statsAutoRefreshInterval = setInterval(async () => {
                if (!backendOnline || isRefreshing) return;
                try {
                    const response = await fetch(`${API_BASE}/db/stats`, {
                        signal: createTimeoutSignal(5000),
                        cache: 'no-cache'
                    });
                    if (response.ok) {
                        const stats = await response.json();
                        const currentSnapshot = JSON.stringify(stats);
                        if (lastStatsSnapshot && currentSnapshot !== lastStatsSnapshot) {
                            // Stats changed, refresh the UI
                            console.log('üìä Stats changed, refreshing...');
                            await loadStats();
                            // If viewing listings table, refresh it too
                            if (currentTable === 'listings') {
                                await loadTable('listings', currentPage);
                            }
                        }
                        lastStatsSnapshot = currentSnapshot;
                    }
                } catch (error) {
                    // Silently fail - don't disrupt user
                }
            }, 15000); // 15 seconds
        }

        // Start auto-refresh after init
        setTimeout(startStatsAutoRefresh, 2000);
    </script>
</body>
</html>
